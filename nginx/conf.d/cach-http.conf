# HTTP-only configuration for Cach Connect
# SSL/HTTPS will be enabled via SSL management workflow

# Upstream definitions for Production
upstream api_production {
    server api-production:3001 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream admin_production {
    server admin-production:3000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream website_production {
    server website-production:3000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream agents_production {
    server agents-production:3000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream minio_production {
    server minio-production:9000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream minio_production_console {
    server minio-production:9001 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Shared services
upstream grafana {
    server cach_grafana:3000;
    keepalive 32;
}

# ===============================
# PRODUCTION ENVIRONMENT SERVERS
# ===============================

# Website Production - HTTP only
server {
    listen 80;
    server_name cachconnect.co.ke www.cachconnect.co.ke;

    # Redirect www to apex domain
    if ($host = www.cachconnect.co.ke) {
        return 301 http://cachconnect.co.ke$request_uri;
    }

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        proxy_pass http://website_production;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Production API Server - HTTP only
server {
    listen 80;
    server_name api.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://api_production;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
}

# Production Admin App - HTTP only
server {
    listen 80;
    server_name admin.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        proxy_pass http://admin_production;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Production Agents App - HTTP only
server {
    listen 80;
    server_name agents.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        proxy_pass http://agents_production;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Grafana Monitoring - HTTP only
server {
    listen 80;
    server_name monitoring.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        proxy_pass http://grafana;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Production MinIO Storage - HTTP only
server {
    listen 80;
    server_name storage.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        proxy_pass http://minio_production;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
