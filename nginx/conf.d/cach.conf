# Upstream definitions for Production
upstream api_production {
    # API container on Docker network
    server cach_api_production:3001;
    keepalive 32;
}

upstream admin_production {
    server cach_admin_production:3000;
    keepalive 32;
}

upstream website_production {
    server cach_website_production:3000;
    keepalive 32;
}

upstream agents_production {
    server cach_agents_production:3000;
    keepalive 32;
}

upstream distributors_production {
    server cach_distributors_production:3000;
    keepalive 32;
}

upstream business_production {
    server cach_business_production:3000;
    keepalive 32;
}

upstream lenders_production {
    server cach_lenders_production:3000;
    keepalive 32;
}

upstream minio_production {
    server cach_minio_production:9000;
    keepalive 32;
}

upstream minio_production_console {
    server cach_minio_production:9001;
    keepalive 32;
}

# Upstream definitions for Staging
upstream api_staging {
    server 127.0.0.1:4001;
    keepalive 32;
}

upstream admin_staging {
    server 127.0.0.1:4051;
    keepalive 32;
}

upstream website_staging {
    server 127.0.0.1:4061;
    keepalive 32;
}

upstream agents_staging {
    server 127.0.0.1:4011;
    keepalive 32;
}

upstream distributors_staging {
    server 127.0.0.1:4021;
    keepalive 32;
}

upstream business_staging {
    server 127.0.0.1:4031;
    keepalive 32;
}

upstream lenders_staging {
    server 127.0.0.1:4041;
    keepalive 32;
}

upstream minio_staging {
    server 127.0.0.1:9010;
    keepalive 32;
}

upstream minio_staging_console {
    server 127.0.0.1:9011;
    keepalive 32;
}

# Upstream definitions for Sandbox
upstream api_sandbox {
    server 127.0.0.1:4002;
    keepalive 32;
}

upstream admin_sandbox {
    server 127.0.0.1:4052;
    keepalive 32;
}

upstream agents_sandbox {
    server 127.0.0.1:4012;
    keepalive 32;
}

upstream distributors_sandbox {
    server 127.0.0.1:4022;
    keepalive 32;
}

upstream business_sandbox {
    server 127.0.0.1:4032;
    keepalive 32;
}

upstream lenders_sandbox {
    server 127.0.0.1:4042;
    keepalive 32;
}

upstream minio_sandbox {
    server 127.0.0.1:9020;
    keepalive 32;
}

upstream minio_sandbox_console {
    server 127.0.0.1:9021;
    keepalive 32;
}

# Shared services
upstream grafana {
    server cach_grafana:3000;
    keepalive 32;
}

# ===============================
# PRODUCTION ENVIRONMENT SERVERS
# ===============================

# Production API Server
server {
    listen 80;
    server_name api.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name api.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/api.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://api_production;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
}

# Production Admin App
server {
    listen 80;
    server_name admin.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name admin.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/admin.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/admin.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://admin_production;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

server {
    listen 80;
    server_name cachconnect.co.ke www.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://website_production;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Production WWW redirect to apex
server {
    listen 443 ssl;
    http2 on;
    server_name www.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/www.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Allow ACME challenges on HTTPS if needed
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://cachconnect.co.ke$request_uri;
    }
}

# Production Agents App
server {
    listen 80;
    server_name agents.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name agents.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/agents.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/agents.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://agents_production;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Production Distributors App
server {
    listen 80;
    server_name distributors.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name distributors.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/distributors.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/distributors.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://distributors_production;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Production Business App
server {
    listen 80;
    server_name business.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name business.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/business.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/business.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://business_production;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Production Lenders App
server {
    listen 80;
    server_name lenders.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name lenders.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/lenders.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/lenders.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://lenders_production;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# =============================
# STAGING ENVIRONMENT SERVERS
# =============================

# Staging API Server
server {
    listen 80;
    server_name api.staging.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name api.staging.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/api.staging.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.staging.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://api_staging;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
}

# Staging Admin App
server {
    listen 80;
    server_name admin.staging.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name admin.staging.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/admin.staging.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/admin.staging.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://admin_staging;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

server {
    listen 80;
    server_name staging.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name staging.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/staging.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/staging.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://website_staging;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Staging Agents App
server {
    listen 80;
    server_name agents.staging.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name agents.staging.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/agents.staging.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/agents.staging.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://agents_staging;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Staging Distributors App
server {
    listen 80;
    server_name distributors.staging.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name distributors.staging.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/distributors.staging.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/distributors.staging.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://distributors_staging;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Staging Business App
server {
    listen 80;
    server_name business.staging.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name business.staging.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/business.staging.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/business.staging.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://business_staging;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Staging Lenders App
server {
    listen 80;
    server_name lenders.staging.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name lenders.staging.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/lenders.staging.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/lenders.staging.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://lenders_staging;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# =============================
# SANDBOX ENVIRONMENT SERVERS
# =============================

# Sandbox API Server
server {
    listen 80;
    server_name api.sandbox.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name api.sandbox.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/api.sandbox.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.sandbox.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://api_sandbox;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
}

# Sandbox Admin App
server {
    listen 80;
    server_name admin.sandbox.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name admin.sandbox.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/admin.sandbox.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/admin.sandbox.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://admin_sandbox;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Sandbox Agents App
server {
    listen 80;
    server_name agents.sandbox.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name agents.sandbox.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/agents.sandbox.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/agents.sandbox.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://agents_sandbox;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Sandbox Distributors App
server {
    listen 80;
    server_name distributors.sandbox.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name distributors.sandbox.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/distributors.sandbox.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/distributors.sandbox.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://distributors_sandbox;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Sandbox Business App
server {
    listen 80;
    server_name business.sandbox.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name business.sandbox.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/business.sandbox.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/business.sandbox.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://business_sandbox;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Sandbox Lenders App
server {
    listen 80;
    server_name lenders.sandbox.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name lenders.sandbox.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/lenders.sandbox.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/lenders.sandbox.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://lenders_sandbox;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# =====================
# SHARED SERVICES
# =====================

# Grafana Monitoring
server {
    listen 80;
    server_name monitoring.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name monitoring.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/monitoring.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/monitoring.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://grafana;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Production MinIO Storage
server {
    listen 80;
    server_name storage.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name storage.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/storage.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/storage.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    ignore_invalid_headers off;
    client_max_body_size 0;
    proxy_buffering off;
    proxy_request_buffering off;

    location / {
        proxy_pass http://minio_production;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Staging MinIO Storage
server {
    listen 80;
    server_name storage.staging.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name storage.staging.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/storage.staging.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/storage.staging.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    ignore_invalid_headers off;
    client_max_body_size 0;
    proxy_buffering off;
    proxy_request_buffering off;

    location / {
        proxy_pass http://minio_staging;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Sandbox MinIO Storage
server {
    listen 80;
    server_name storage.sandbox.cachconnect.co.ke;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name storage.sandbox.cachconnect.co.ke;

    ssl_certificate /etc/letsencrypt/live/storage.sandbox.cachconnect.co.ke/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/storage.sandbox.cachconnect.co.ke/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    ignore_invalid_headers off;
    client_max_body_size 0;
    proxy_buffering off;
    proxy_request_buffering off;

    location / {
        proxy_pass http://minio_sandbox;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}